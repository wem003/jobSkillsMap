{% extends "base.html" %}
{% block title %}jobSkillsMap{% endblock %}
<br>
<br>
<br>
{% block content %}

{% if err == 'missing' %}
  <div class="flash">Please provide Company, Title, and Description.</div>
{% endif %}
{% if ok == 'added' %}
  <div class="flash">Job description added to Pending.</div>
{% elif ok == 'moved' %}
  <div class="flash">Moved to Processed.</div>
{% endif %}

<!-- Add form -->
<div class="card">
  <h2>Add Job Description</h2>
    <form action="{{ url_for('ui.upload') }}" method="post" class="grid">
      <div class="field">
        <label>Company</label>
        <input name="company" required />
      </div>
      <div class="field">
        <label>Title</label>
        <input name="title" required />
      </div>
      <div class="field" style="grid-column: 1 / -1;">
        <label>Description</label>
        <textarea name="description" rows="6" required></textarea>
      </div>
      <div style="grid-column: 1 / -1; display:flex; gap: 8px;">
        <button class="btn btn-primary" type="submit">Submit</button>
        <button class="btn" type="reset">Clear</button>
      </div>
    </form>
</div>

<hr style="border:none; border-top:1px solid var(--border); margin:24px 0;">

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn" data-tab="waiting">Waiting ({{ waiting|length }})</button>
  <button class="tab-btn" data-tab="processed">Processed ({{ processed|length }})</button>
</div>

<!-- Tab panels -->
<div id="tab-waiting" class="tab-panel card" style="margin-top:8px;">
  <h2>Waiting</h2>
  <table>
    <thead><tr><th>File</th><th>Size</th><th>Modified</th><th>Actions</th></tr></thead>
    <tbody>
    {% for f in waiting %}
      <tr>
        <td>{{ f.name }}</td>
        <td>{{ f.size_kb }} KB</td>
        <td>{{ f.mtime }}</td>
        <td>
          <form class="inline" method="post" action="{{ url_for('ui.mark_processed', file_id=f.id) }}">
            <button class="btn" type="submit">Mark processed</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="4">No files waiting.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<div id="tab-processed" class="tab-panel card" style="margin-top:8px; display:none;">
  <h2>Processed</h2>
  <table>
    <thead><tr><th>File</th><th>Size</th><th>Modified</th></tr></thead>
    <tbody>
    {% for f in processed %}
      <tr>
        <td>{{ f.name }}</td>
        <td>{{ f.size_kb }} KB</td>
        <td>{{ f.mtime }}</td>
      </tr>
    {% else %}
      <tr><td colspan="3">No files processed yet.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>
  (function() {
    const btns = Array.from(document.querySelectorAll(".tab-btn"));
    const panels = {
      waiting: document.getElementById("tab-waiting"),
      processed: document.getElementById("tab-processed"),
    };

    function activate(name, pushHash=true) {
      btns.forEach(b => b.classList.toggle("active", b.dataset.tab === name));
      Object.entries(panels).forEach(([k, el]) => { el.style.display = (k === name) ? "" : "none"; });
      if (pushHash) location.hash = name;
      try { sessionStorage.setItem("activeTab", name); } catch(e) {}
    }

    const hash = (location.hash || "").replace("#", "");
    const saved = (() => { try { return sessionStorage.getItem("activeTab"); } catch(e) { return null; } })();
    const initial = (hash === "processed" || hash === "waiting")
      ? hash : (saved === "processed" || saved === "waiting" ? saved : "waiting");
    activate(initial, false);

    btns.forEach(b => b.addEventListener("click", () => activate(b.dataset.tab)));
    window.addEventListener("hashchange", () => {
      const h = location.hash.replace("#", "");
      if (h === "waiting" || h === "processed") activate(h, false);
    });
  })();
</script>

{% endblock %}